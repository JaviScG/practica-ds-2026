name: CI/CD Pipeline Analizador

on:
  push:
    branches: [ "main", "feature/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. ETAPA DE CONSTRUCCIÓN Y TESTS (CI)
  build-and-test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Q1 y Q2: Pruebas unitarias e integración
      - name: Ejecutar Tests (Q1 y Q2)
        run: pytest

  # 2. NUEVA ETAPA VISUAL: CALIDAD Y SEGURIDAD (Q4)
  quality-analysis:
    name: Q4 - Calidad y Seguridad
    needs: build-and-test  # Se ejecuta después de que pasen los tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar herramientas de análisis
        run: |
          python -m pip install --upgrade pip
          pip install bandit flake8

      # Q4: Análisis estático
      - name: Análisis de Seguridad (Bandit)
        run: bandit -r . -f custom || true  # El || true evita que falle el pipeline si encuentra algo leve

      - name: Análisis de Calidad (Flake8)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  # 3. ETAPA DE DESPLIEGUE (CD)
  deploy:
    name: Deploy to Production
    needs: quality-analysis # Ahora depende de que pase la calidad, no solo los tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Simular Despliegue
        run: |
          echo "Desplegando automáticamente a producción tras validar CI y Q4..."
          echo "Estado: Verde en producción."